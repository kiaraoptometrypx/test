<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OCR for Prescription Numbers (Mobile Friendly)</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f7f7;
  padding: 40px;
  color: #333;
}
.container {
  max-width: 720px;
  margin: auto;
  background: white;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
canvas {
  max-width: 100%;
  border: 1px solid #ccc;
  border-radius: 8px;
  touch-action: none;
}
button {
  background: #009879;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  margin: 8px 6px 0 0;
}
button:hover { background: #007a63; }
#progress {
  margin-top: 10px;
  width: 100%;
  height: 6px;
  background: #ddd;
  border-radius: 4px;
  overflow: hidden;
}
#bar {
  width: 0%;
  height: 100%;
  background: #009879;
}
pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  background: #fafafa;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #ddd;
  margin-top: 15px;
}
</style>
</head>
<body>
<div class="container">
  <h2>Prescription OCR â€” Numeric Optimized</h2>
  <input type="file" id="imageInput" accept="image/*"><br>
  <canvas id="canvas"></canvas><br>
  <button onclick="extractCropped()">Extract Cropped Text</button>
  <div id="progress"><div id="bar"></div></div>
  <pre id="result">No text extracted yet.</pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let img = new Image(), startX, startY, endX, endY, drawing = false;

// === Load Image ===
document.getElementById('imageInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  img.src = URL.createObjectURL(file);
  img.onload = () => {
    canvas.width = img.width > 700 ? 700 : img.width;
    const scale = canvas.width / img.width;
    canvas.height = img.height * scale;
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  };
});

// === Crop Drawing (Mouse + Touch) ===
function startDraw(x, y){ startX = x; startY = y; drawing = true; }
function moveDraw(x, y){
  if (!drawing) return;
  endX = x; endY = y;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'rgba(255,0,0,0.25)';
  ctx.strokeStyle = 'red';
  ctx.lineWidth = 2;
  const w = endX - startX, h = endY - startY;
  ctx.fillRect(startX, startY, w, h);
  ctx.strokeRect(startX, startY, w, h);
}
function endDraw(){ drawing = false; }

canvas.addEventListener('mousedown', e => {
  const r = canvas.getBoundingClientRect();
  startDraw(e.clientX - r.left, e.clientY - r.top);
});
canvas.addEventListener('mousemove', e => {
  const r = canvas.getBoundingClientRect();
  moveDraw(e.clientX - r.left, e.clientY - r.top);
});
canvas.addEventListener('mouseup', endDraw);

canvas.addEventListener('touchstart', e => {
  const r = canvas.getBoundingClientRect();
  const t = e.touches[0];
  startDraw(t.clientX - r.left, t.clientY - r.top);
});
canvas.addEventListener('touchmove', e => {
  const r = canvas.getBoundingClientRect();
  const t = e.touches[0];
  moveDraw(t.clientX - r.left, t.clientY - r.top);
});
canvas.addEventListener('touchend', endDraw);

// === OCR Extraction ===
async function extractCropped() {
  const resEl = document.getElementById('result');
  if (endX == null || endY == null) {
    alert('Draw a crop box first.');
    return;
  }
  resEl.textContent = 'Reading text... please wait.';

  // Create cropped area
  const w = Math.abs(endX - startX), h = Math.abs(endY - startY);
  const x = Math.min(startX, endX), y = Math.min(startY, endY);
  const crop = document.createElement('canvas');
  crop.width = w; crop.height = h;
  const cctx = crop.getContext('2d');
  // Enhance image for numeric accuracy
  cctx.filter = 'contrast(200%) brightness(120%) grayscale(100%) blur(0.8px)';
  cctx.drawImage(canvas, x, y, w, h, 0, 0, w, h);

  const { data: { text } } = await Tesseract.recognize(crop.toDataURL('image/png'), 'eng', {
    langPath: 'https://tessdata.projectnaptha.com/4.0.0_best/',
    tessedit_char_whitelist: '0123456789.-+',
    tessedit_pageseg_mode: 6,
    logger: info => {
      if (info.status === 'recognizing text') {
        document.getElementById('bar').style.width = Math.round(info.progress * 100) + '%';
      }
    }
  });

  // Clean and correct output
  let clean = text
    .replace(/O/g, '0')
    .replace(/l/g, '1')
    .replace(/S/g, '5')
    .replace(/[^0-9.+\-\n ]/g, '')
    .trim();

  resEl.textContent = clean || 'No text found.';
  document.getElementById('bar').style.width = '0%';
}
</script>
</body>
</html>
